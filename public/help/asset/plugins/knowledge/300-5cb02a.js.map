{"version":3,"file":"300-5cb02a.js","mappings":"gMAIc,SAAUA,EAAV,GAA8D,IAA3C,SAAEC,GAAyC,EAExE,MAAM,UAAEC,EAAF,MAAaC,IAAUC,EAAAA,EAAAA,YAAW,SAClC,WAAEC,IAAeD,EAAAA,EAAAA,YAAW,WAC5B,QAAEE,IAAYC,EAAAA,EAAAA,WACdC,GAAUC,EAAAA,EAAAA,gBACVC,GAAUC,EAAAA,EAAAA,MACVC,GAAOC,EAAAA,EAAAA,YAEbC,EAAAA,EAAAA,UAAQ,KACJZ,GAAU,IAAgB,IAAf,QAAEa,GAAa,EACtBA,EAAQC,IAAIN,EAAQO,yBAEzB,KAEHC,EAAAA,EAAAA,YAAU,MACDV,GAAWI,GAEZP,GAAWc,UACP,IACI,MAAM,KAAEC,SAAeL,EAAAA,QAAAA,KAAoBH,EAAKS,SAAS,UAAW,CAChEC,UACAC,IAAKb,EAAQa,MAGjB,OAAOH,EAAKI,KAAKC,IACTf,EAAQa,IAAIG,SAASD,EAAKE,QAC1BF,EAAKG,KAAOlB,EAAQmB,YAAYJ,EAAKE,KAAMF,EAAKG,OAG7C,CACHE,MAAOL,EAAKK,MACZF,KAAMH,EAAKG,SAGrB,MACE,MAAO,SAIpB,CAAChB,IAEJ,MAAMmB,GAAejB,EAAAA,EAAAA,UAAQ,IACTR,EAAQ0B,YAAWC,GAAWA,EAAQC,YAActB,EAAKgB,QAEzC,eAAdhB,EAAKgB,MACxB,CAAChB,IA0BJ,OAxBAM,EAAAA,EAAAA,YAAU,KACN,GAAIa,OACqBI,IAAjBvB,EAAKwB,SAELjC,EAAMkC,EAAAA,QAAAA,SAAAA,cAEP,CACH,MAAMC,EAAK5B,EAAQ6B,YAAY3B,EAAKgB,MACpC,GAAIU,EAAI,CACJ,MAAML,EAAU3B,EAAQ0B,YAAW,KACxB,IACPQ,GAASA,EAAKC,YAAY,eAAiBH,IAE/C,GAAIL,EAEA,YADAI,EAAAA,QAAAA,QAAgBzB,EAAKS,SAASY,EAAQL,OAM9CS,EAAAA,QAAAA,QAAgBzB,EAAKS,SAAS,SAEnC,IAEEU,EAIE9B,EAHI","sources":["webpack://TopWritePlugins.knowledge/./src/components/reader/activate.tsx"],"sourcesContent":["import { GetComponentProps, history, request, useActions, useBook, useFile, useInPreview } from 'topwrite';\r\nimport { useEffect, useMemo } from 'react';\r\nimport { useSubBook } from '@/lib/sub-book';\r\n\r\nexport default function Activate({ children }: GetComponentProps<'activate'>) {\r\n\r\n    const { intercept, fetch } = useActions('page');\r\n    const { setHandler } = useActions('search');\r\n    const { summary } = useBook();\r\n    const preview = useInPreview();\r\n    const subBook = useSubBook();\r\n    const file = useFile();\r\n\r\n    useMemo(() => {\r\n        intercept(({ request }) => {\r\n            request.use(subBook.interceptRequest());\r\n        });\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        if (!preview && file) {\r\n            //TODO 检查服务端是否支持全文搜索\r\n            setHandler(async (keyword) => {\r\n                try {\r\n                    const { data } = await request.post<any[]>(file.relative('search'), {\r\n                        keyword,\r\n                        ids: subBook.ids\r\n                    });\r\n\r\n                    return data.map((item) => {\r\n                        if (subBook.ids.includes(item.book)) {\r\n                            item.path = subBook.resolvePath(item.book, item.path);\r\n                        }\r\n\r\n                        return {\r\n                            title: item.title,\r\n                            path: item.path\r\n                        };\r\n                    });\r\n                } catch {\r\n                    return [];\r\n                }\r\n            });\r\n        }\r\n    }, [file]);\r\n\r\n    const articleMatch = useMemo(() => {\r\n        const article = summary.getArticle(article => article.getPath() === file.path);\r\n\r\n        return article || file.path === 'index.html';\r\n    }, [file]);\r\n\r\n    useEffect(() => {\r\n        if (articleMatch) {\r\n            if (file.content === undefined) {\r\n                //重新加载\r\n                fetch(history.location.pathname);\r\n            }\r\n        } else {\r\n            const id = subBook.resolveBook(file.path);\r\n            if (id) {\r\n                const article = summary.getArticle(() => {\r\n                    return true;\r\n                }, (part) => part.getMetadata('reference') === id);\r\n\r\n                if (article) {\r\n                    history.replace(file.relative(article.path));\r\n                    return;\r\n                }\r\n            }\r\n\r\n            //跳转首页\r\n            history.replace(file.relative('/'));\r\n        }\r\n    }, []);\r\n\r\n    if (!articleMatch) {\r\n        return null;\r\n    }\r\n\r\n    return children;\r\n}\r\n"],"names":["Activate","children","intercept","fetch","useActions","setHandler","summary","useBook","preview","useInPreview","subBook","useSubBook","file","useFile","useMemo","request","use","interceptRequest","useEffect","async","data","relative","keyword","ids","map","item","includes","book","path","resolvePath","title","articleMatch","getArticle","article","getPath","undefined","content","history","id","resolveBook","part","getMetadata"],"sourceRoot":""}